<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Latihan Video Call</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      color: #fff;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header { text-align: center; padding: 1rem; background: rgba(0,0,0,0.3); }
    h2 { margin: 0; font-size: 1.5rem; }
    .video-container {
      flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px;
    }
    video {
      width: 100%; max-height: 45vh; border-radius: 12px; background: #000;
      object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .controls {
      display: flex; justify-content: center; flex-wrap: wrap;
      gap: 10px; padding: 15px; background: rgba(0,0,0,0.3);
    }
    button, select {
      border: none; padding: 12px 18px; border-radius: 8px;
      font-size: 15px; font-weight: 600; cursor: pointer; transition: 0.25s; color: #fff;
    }
    button#startBtn { background: #28a745; }
    button#callBtn { background: #007bff; }
    button#answerBtn { background: #17a2b8; }
    button#hangupBtn { background: #dc3545; }
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    select { background:#444; color:#fff; }
    @media (max-width: 768px) {
      .video-container { grid-template-columns: 1fr; }
      video { max-height: 40vh; }
    }
  </style>
</head>
<body>
  <header>
    <h2>ğŸ“± Latihan Video Call WebRTC + Firebase Auth</h2>
  </header>

  <div class="video-container">
    <video id="localVideo" autoplay playsinline muted></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <div class="controls">
    <button id="startBtn">Start Kamera</button>
    <button id="callBtn">Buat Panggilan</button>
    <button id="answerBtn">Jawab Panggilan</button>
    <button id="hangupBtn">Matikan Panggilan</button>
    <select id="ringtoneSelect">
      <option value="ring1.mp3">ğŸ”” Nada 1</option>
      <option value="ring2.mp3">ğŸ”” Nada 2</option>
      <option value="ring3.mp3">ğŸ”” Nada 3</option>
    </select>
    <select id="qualitySelect">
      <option value="low">ğŸ”‹ Hemat Kuota</option>
      <option value="high" selected>ğŸŒ Kualitas Tinggi</option>
    </select>
  </div>

  <audio id="ringtone" loop></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
  apiKey: "AIzaSyDJmgQ6VUSGNXeUxnyIgTUmt6j90p8CuJA",
  authDomain: "cam4all-82c58.firebaseapp.com",
  databaseURL: "https://cam4all-82c58-default-rtdb.firebaseio.com",
  projectId: "cam4all-82c58",
  storageBucket: "cam4all-82c58.firebasestorage.app",
  messagingSenderId: "1047523885224",
  appId: "1:1047523885224:web:662731cc217b6da13f029d"
};

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Anonymous login
    signInAnonymously(auth)
      .then(() => console.log("âœ… Signed in anonymously"))
      .catch(err => console.error("âŒ Auth error:", err));

    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("âœ… User UID:", user.uid);
      }
    });

    // Elements
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const startBtn = document.getElementById("startBtn");
    const callBtn = document.getElementById("callBtn");
    const answerBtn = document.getElementById("answerBtn");
    const hangupBtn = document.getElementById("hangupBtn");
    const ringtone = document.getElementById("ringtone");
    const ringtoneSelect = document.getElementById("ringtoneSelect");
    const qualitySelect = document.getElementById("qualitySelect");

    let localStream, pc;

    // ğŸ¶ Pilih nada dering
    ringtone.src = ringtoneSelect.value;
    ringtoneSelect.onchange = () => { ringtone.src = ringtoneSelect.value; };

    // Start Kamera dengan toggle kualitas
    startBtn.onclick = async () => {
      const mode = qualitySelect.value;
      let constraints;
      if (mode === "low") {
        constraints = { video: { width: 240, height: 180, frameRate: 12 }, audio: true };
      } else {
        constraints = { video: { width: 320, height: 240, frameRate: 15 }, audio: true };
      }
      localStream = await navigator.mediaDevices.getUserMedia(constraints);
      localVideo.srcObject = localStream;
    };

    // RTCPeerConnection
    function createPeerConnection() {
      pc = new RTCPeerConnection();
      pc.onicecandidate = (e) => {
        if (e.candidate) {
          set(ref(db, "call/candidate"), JSON.stringify(e.candidate));
        }
      };
      pc.ontrack = (e) => { remoteVideo.srcObject = e.streams[0]; };
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    }

    // Buat Panggilan
    callBtn.onclick = async () => {
      createPeerConnection();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await set(ref(db, "call/offer"), JSON.stringify(offer));

      onValue(ref(db, "call/answer"), async (snap) => {
        if (snap.val()) {
          const answer = JSON.parse(snap.val());
          await pc.setRemoteDescription(answer);
        }
      });

      onValue(ref(db, "call/candidate"), async (snap) => {
        if (snap.val()) {
          try { await pc.addIceCandidate(JSON.parse(snap.val())); } catch {}
        }
      });
    };

    // Jawab Panggilan
    answerBtn.onclick = async () => {
      createPeerConnection();

      onValue(ref(db, "call/offer"), async (snap) => {
        if (snap.val()) {
          // ğŸ”” Bunyi dering saat ada offer
          ringtone.play().catch(()=>{});

          const offer = JSON.parse(snap.val());
          await pc.setRemoteDescription(offer);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          await set(ref(db, "call/answer"), JSON.stringify(answer));

          // ğŸ”‡ Hentikan dering setelah menjawab
          ringtone.pause(); ringtone.currentTime = 0;
        }
      });

      onValue(ref(db, "call/candidate"), async (snap) => {
        if (snap.val()) {
          try { await pc.addIceCandidate(JSON.parse(snap.val())); } catch {}
        }
      });
    };

    // Matikan Panggilan
    hangupBtn.onclick = () => {
      if (pc) {
        pc.close();
        pc = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localVideo.srcObject = null;
      }
      remoteVideo.srcObject = null;

      set(ref(db, "call"), null);
      ringtone.pause(); ringtone.currentTime = 0;
      alert("Panggilan dimatikan");
    };
  </script>
</body>
</html>
