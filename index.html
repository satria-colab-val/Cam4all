<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Video Call Mobile Modern</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    body { margin:0; font-family: sans-serif; background:#111; color:#fff; overflow:hidden; }
    header { padding:10px; text-align:center; background:#222; font-weight:bold; }
    .video-wrapper { position:relative; width:100%; height:calc(100vh - 150px); background:#000; }
    #remoteVideo { width:100%; height:100%; object-fit:cover; background:#000; }
    #localVideo {
      position:absolute; bottom:90px; right:10px;
      width:120px; height:90px; background:#000; border:2px solid #fff;
      border-radius:8px; object-fit:cover;
    }
    .controls {
      position:fixed; bottom:0; width:100%; background:#222;
      display:flex; flex-wrap:wrap; justify-content:center; padding:10px; gap:5px;
    }
    button, select, input {
      padding:10px; border:none; border-radius:8px; font-weight:bold;
    }
    button { color:#fff; cursor:pointer; }
    #startBtn { background:#28a745; }
    #createRoomBtn { background:#007bff; }
    #joinRoomBtn { background:#17a2b8; }
    #hangupBtn { background:#dc3545; }
  </style>
</head>
<body>
  <header>📱 Video Call Room</header>

  <div class="video-wrapper">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline muted></video>
  </div>

  <div class="controls">
    <button id="startBtn">🎥 Kamera</button>
    <button id="createRoomBtn">➕ Buat Room</button>
    <input id="roomIdInput" placeholder="Room ID" />
    <button id="joinRoomBtn">➡️ Join</button>
    <button id="hangupBtn">❌ Hangup</button>
    <select id="ringtoneSelect">
      <option value="ring1.mp3">🔔 Nada 1</option>
      <option value="ring2.mp3">🔔 Nada 2</option>
      <option value="ring3.mp3">🔔 Nada 3</option>
    </select>
    <select id="qualitySelect">
      <option value="low">🔋 Hemat Kuota</option>
      <option value="high" selected>🌐 Kualitas Tinggi</option>
    </select>
  </div>

  <!-- Nada dering -->
  <audio id="ringtone" loop></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // 🔧 Firebase Config
    const firebaseConfig = {
  apiKey: "AIzaSyDJmgQ6VUSGNXeUxnyIgTUmt6j90p8CuJA",
  authDomain: "cam4all-82c58.firebaseapp.com",
  databaseURL: "https://cam4all-82c58-default-rtdb.firebaseio.com",
  projectId: "cam4all-82c58",
  storageBucket: "cam4all-82c58.firebasestorage.app",
  messagingSenderId: "1047523885224",
  appId: "1:1047523885224:web:662731cc217b6da13f029d"
};
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // 🔑 Login Anonymous
    signInAnonymously(auth).then(() => console.log("✅ Login anon"));

    // 🎥 Elemen
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const startBtn = document.getElementById("startBtn");
    const createRoomBtn = document.getElementById("createRoomBtn");
    const joinRoomBtn = document.getElementById("joinRoomBtn");
    const hangupBtn = document.getElementById("hangupBtn");
    const roomIdInput = document.getElementById("roomIdInput");
    const ringtone = document.getElementById("ringtone");
    const ringtoneSelect = document.getElementById("ringtoneSelect");
    const qualitySelect = document.getElementById("qualitySelect");

    let localStream, pc, currentRoomRef;

    // 🎶 Pilih nada dering
    ringtone.src = ringtoneSelect.value;
    ringtoneSelect.onchange = () => { ringtone.src = ringtoneSelect.value; };

    // 📹 Start Kamera
    startBtn.onclick = async () => {
      const mode = qualitySelect.value;
      let constraints;
      if (mode === "low") {
        constraints = { video: { width: 240, height: 180, frameRate: 12 }, audio: true };
      } else {
        constraints = { video: { width: 320, height: 240, frameRate: 15 }, audio: true };
      }

      localStream = await navigator.mediaDevices.getUserMedia(constraints);
      localVideo.srcObject = localStream;
    };

    // 🔧 Buat PeerConnection
    function createPeerConnection(roomPath) {
      pc = new RTCPeerConnection();
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      pc.ontrack = (e) => { remoteVideo.srcObject = e.streams[0]; };
      pc.onicecandidate = (e) => {
        if (e.candidate) {
          const candRef = ref(db, `${roomPath}/candidates`);
          set(push(candRef), e.candidate.toJSON());
        }
      };
    }

    // 📞 Buat Room
    createRoomBtn.onclick = async () => {
      const manualId = roomIdInput.value.trim() || prompt("Masukkan kode Room (bebas):");
      if (!manualId) return alert("Room ID wajib diisi!");
      const roomId = manualId;
      roomIdInput.value = roomId;
      currentRoomRef = `rooms/${roomId}`;
      console.log("📤 Room dibuat:", roomId);

      createPeerConnection(currentRoomRef);

      // Atur bitrate kalau mode low
      if (qualitySelect.value === "low") {
        pc.onnegotiationneeded = async () => {
          const sender = pc.getSenders().find(s => s.track && s.track.kind === "video");
          if (sender) {
            const params = sender.getParameters();
            if (!params.encodings) params.encodings = [{}];
            params.encodings[0].maxBitrate = 150 * 1000; // 150 kbps
            await sender.setParameters(params);
          }
        };
      }

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await set(ref(db, `${currentRoomRef}/offer`), offer);

      onValue(ref(db, `${currentRoomRef}/answer`), async (snap) => {
        if (snap.val()) await pc.setRemoteDescription(snap.val());
      });
      onValue(ref(db, `${currentRoomRef}/candidates`), async (snap) => {
        if (snap.val()) {
          for (const c of Object.values(snap.val())) {
            try { await pc.addIceCandidate(c); } catch {}
          }
        }
      });
      alert(`Room ID: ${roomId}`);
    };

    // 📥 Join Room
    joinRoomBtn.onclick = async () => {
      const roomId = roomIdInput.value.trim();
      if (!roomId) return alert("Masukkan Room ID");
      currentRoomRef = `rooms/${roomId}`;
      createPeerConnection(currentRoomRef);

      // Atur bitrate kalau mode low
      if (qualitySelect.value === "low") {
        pc.onnegotiationneeded = async () => {
          const sender = pc.getSenders().find(s => s.track && s.track.kind === "video");
          if (sender) {
            const params = sender.getParameters();
            if (!params.encodings) params.encodings = [{}];
            params.encodings[0].maxBitrate = 150 * 1000; // 150 kbps
            await sender.setParameters(params);
          }
        };
      }

      onValue(ref(db, `${currentRoomRef}/offer`), async (snap) => {
        if (snap.val()) {
          // 🔔 Bunyi saat ada offer
          ringtone.play().catch(()=>{});
          await pc.setRemoteDescription(snap.val());
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          await set(ref(db, `${currentRoomRef}/answer`), answer);
          // 🔇 Hentikan ringtone setelah jawab
          ringtone.pause(); ringtone.currentTime = 0;
        }
      });
      onValue(ref(db, `${currentRoomRef}/candidates`), async (snap) => {
        if (snap.val()) {
          for (const c of Object.values(snap.val())) {
            try { await pc.addIceCandidate(c); } catch {}
          }
        }
      });
    };

    // ❌ Hangup
    hangupBtn.onclick = async () => {
      if (pc) { pc.close(); pc = null; }
      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localVideo.srcObject = null;
      }
      remoteVideo.srcObject = null;
      if (currentRoomRef) await remove(ref(db, currentRoomRef));
      ringtone.pause(); ringtone.currentTime = 0;
      alert("Panggilan dimatikan");
    };
  </script>
</body>
</html>
